<script>
  const league = document.getElementById('league');
const leaderboard = document.getElementById('leaderboard');
const knockout = document.getElementById('knockout');
const STORE = 'ironFist_FINAL';

const players=["Kakuzu","Minato","Kabuto","Orochimaru","Naruto","Kakashi","Rocklee","Sasuke","Gaara","Kankuro","Sakura","Might Guy","Choji","Hinata","Hidan","Chiyo","Tsunade","Small Kakashi","Tenten","Kurenai","Jugo","Sasori","Itachi","Kisame","Pain","Temari","Neji","Shikamaru","Ino","Kiba","Suigetsu","Tobi","Shizune","Asuma","Shino","Deidara","Konan","Sai","Karin","Yamato","Jiraiya","Small Obito","Hashirama"];

let state={
  league:[],
  points:{},
  ko:{ r32:[], r16:[], qf:[], sf:[], final:[], champion:null }
};

// ---------- SAVE / LOAD ----------
function save(){ localStorage.setItem(STORE,JSON.stringify(state)); }
function load(){
  const d=localStorage.getItem(STORE);
  if(d){ state=JSON.parse(d); return true; }
  return false;
}

// ---------- INIT ----------
function init(){
  players.forEach(p=>state.points[p]=0);
  for(let i=0;i<players.length;i++){
    for(let j=i+1;j<i+4 && j<players.length;j++){
      state.league.push({a:players[i],b:players[j],w:null});
    }
  }
  save();
}
if(!load()) init();

// ---------- LEAGUE ----------
function renderLeague(){
  league.innerHTML='';
  state.league.forEach((m,i)=>{
    league.innerHTML+=`
    <div class="${m.w?'completed-match':''}">
      ${m.a} vs ${m.b}
      ${m.w?`<span class="tick">‚úî</span>`:`
      <button class="win-btn" onclick="winLeague(${i},'a')">${m.a}</button>
      <button class="win-btn" onclick="winLeague(${i},'b')">${m.b}</button>`}
    </div>`;
  });
}

function winLeague(i,s){
  if(state.league[i].w) return;
  const w=s==='a'?state.league[i].a:state.league[i].b;
  state.league[i].w=w;
  state.points[w]+=3;
  save();
  renderLeague();
  renderBoard();
}

// ---------- LEADERBOARD ----------
function renderBoard(){
  const arr=Object.keys(state.points)
    .map(p=>({p,pts:state.points[p]}))
    .sort((a,b)=>b.pts-a.pts);

  leaderboard.innerHTML='';
  arr.forEach((x,i)=>{
    leaderboard.innerHTML+=`<tr><td>${i+1}</td><td>${x.p}</td><td>${x.pts}</td></tr>`;
  });

  if(state.ko.r32.length===0 && arr.length>=32){
    startKO(arr.slice(0,32).map(x=>x.p));
  }
}

// ---------- KNOCKOUT ----------
function startKO(list){
  state.ko.r32=[];
  for(let i=0;i<16;i++){
    state.ko.r32.push({a:list[i],b:list[31-i],w:null});
  }
  save();
  renderKO();
}

function nextRound(curr,next){
  if(curr.every(m=>m.w)){
    state.ko[next]=[];
    for(let i=0;i<curr.length;i+=2){
      state.ko[next].push({a:curr[i].w,b:curr[i+1].w,w:null});
    }
  }
}

function renderKO(){
  knockout.innerHTML='';
  drawRound("Round of 32","r32","r16");
  drawRound("Round of 16","r16","qf");
  drawRound("Quarterfinal","qf","sf");
  drawRound("Semifinal","sf","final");
  drawFinal();
}

function drawRound(title,key,next){
  if(state.ko[key].length===0) return;
  knockout.innerHTML+=`<h3>${title}</h3>`;
  state.ko[key].forEach((m,i)=>{
    knockout.innerHTML+=`
    <div class="${m.w?'completed-match':''}">
      ${m.a} vs ${m.b}
      ${m.w?`<span class="tick">‚úî</span>`:`
      <button onclick="winKO('${key}',${i},'a')">Win</button>
      <button onclick="winKO('${key}',${i},'b')">Win</button>`}
    </div>`;
  });
  nextRound(state.ko[key],next);
}

function winKO(r,i,s){
  const m=state.ko[r][i];
  if(m.w) return;
  m.w=s==='a'?m.a:m.b;
  save();
  renderKO();
}

function drawFinal(){
  if(state.ko.final.length!==1) return;
  const m=state.ko.final[0];
  knockout.innerHTML+=`
  <h3>Final</h3>
  <div class="${m.w?'completed-match':''}">
    ${m.a} vs ${m.b}
    ${m.w?`<h2>üèÜ Champion: ${m.w}</h2>`:`
    <button onclick="winKO('final',0,'a')">Win</button>
    <button onclick="winKO('final',0,'b')">Win</button>`}
  </div>`;
}

// ---------- RESET ----------
function resetAll(){
  if(!confirm("Reset all data?")) return;
  localStorage.removeItem(STORE);
  location.reload();
}

// ---------- RENDER ----------
renderLeague();
renderBoard();
renderKO();
</script>
